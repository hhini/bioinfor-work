---
title: å¤šå…ƒæ•°æ®åˆ†æä½œä¸š
authors:
  - name: å‘¨æ° 113120230073
    affiliation: The GanNan medical University 
    roles: writing
    corresponding: true
bibliography: references.bib
---

# å¤šå…ƒæ•°æ®åˆ†æä½œä¸š

## ğŸ§¬ TCGA-LUSC é¡¹ç›®æ•°æ®ç®€æŠ¥

### ğŸ“Œ é¡¹ç›®åŸºæœ¬ä¿¡æ¯

| é¡¹ç›®å­—æ®µ            | å†…å®¹                                         |
|---------------------|----------------------------------------------|
| **Project ID**      | TCGA-LUSC                                    |
| **dbGaP Accession** | phs000178                                    |
| **é¡¹ç›®åç§°**        | è‚ºé³çŠ¶ç»†èƒç™Œï¼ˆLung Squamous Cell Carcinomaï¼‰ |
| **ç–¾ç—…ç±»å‹**        | 2ç§ç–¾ç—…ç±»å‹ï¼ˆåŒ…æ‹¬è‚ºé³ç™ŒåŠç›¸å…³äºšå‹ï¼‰          |
| **ä¸»ç«™ç‚¹**          | æ”¯æ°”ç®¡å’Œè‚ºï¼ˆBronchus and Lungï¼‰              |
| **æ‰€å±è®¡åˆ’**        | TCGAï¼ˆç™Œç—‡åŸºå› ç»„å›¾è°±è®¡åˆ’ï¼‰                   |

### ğŸ§ª æ•°æ®ç±»å‹ä¸å¯ç”¨æ€§

| æ•°æ®ç±»å‹    | æ ·æœ¬æ•°é‡ | è¦†ç›–ç‡ | å¤‡æ³¨è¯´æ˜                            |
|-------------|----------|--------|-------------------------------------|
| **RNA-Seq** | 501      | 99.4%  | é«˜è¦†ç›–ç‡ï¼Œé€‚ç”¨äºå·®å¼‚è¡¨è¾¾åˆ†æï¼ˆDEGï¼‰ |

## ç¬¬ä¸€æ­¥ï¼šè½½å…¥æ•°æ®

```{r}

#### 1. å®‰è£…/è½½å…¥å¿…è¦åŒ… ####
#required_pkgs <- c("DESeq2","edgeR","limma","cluster","factoextra","NbClust",
 #                  "pheatmap","RColorBrewer","ggplot2","dplyr","sva","BiocManager")
#for(pkg in required_pkgs){
 # if(!requireNamespace(pkg, quietly = TRUE)){
  #  if(pkg == "BiocManager") install.packages("BiocManager")
  #  else if(pkg %in% c("DESeq2","edgeR","limma","sva"))
   #   BiocManager::install(pkg, ask = FALSE, update = FALSE)
  #  else install.packages(pkg)
  #}
 # library(pkg, character.only = TRUE)
#}
# ---- 1. è½½å…¥/å®‰è£…å¿…è¦åŒ… ----
pkgs_cran <- c("pheatmap","ggplot2","dplyr","RColorBrewer","factoextra","cluster","NbClust")
pkgs_bioc  <- c("DESeq2","edgeR","apeglm","WGCNA")

for(p in pkgs_cran){
  if(!requireNamespace(p, quietly = TRUE)) install.packages(p)
  library(p, character.only = TRUE)
}
if(!requireNamespace("BiocManager", quietly = TRUE)) install.packages("BiocManager")
for(p in pkgs_bioc){
  if(!requireNamespace(p, quietly = TRUE)) BiocManager::install(p, ask = FALSE, update = FALSE)
  library(p, character.only = TRUE)
}

```

```{r}
library(readr)
final_data <- read_csv("E:/acode/wsl/data2/GDCdata/TCGA-LUSC/rnaexp.csv", col_names = TRUE)
final_data <- final_data[ , -1]  # åˆ é™¤ç¬¬ä¸€åˆ—

clinical_data <- read_csv("E:/acode/wsl/data2/GDCdata/TCGA-LUSC/clinical_metadata.csv", col_names = TRUE)


```

```{r}

#|echo:true
head(clinical_data)
head(final_data)
```

## ğŸ§¾ 1. ä¸´åºŠæ•°æ®ï¼ˆclinical_dataï¼‰

è¿™æ˜¯ä¸€ä¸ªåŒ…å« **æ ·æœ¬åŸºæœ¬ä¿¡æ¯å’Œåˆ†æœŸåˆ†ç±»** çš„è¡¨æ ¼ï¼š

| åˆ—å | ç±»å‹ | è¯´æ˜ |
|------------------------|------------------------|------------------------|
| `case_id` | å­—ç¬¦å‹ | TCGA æ ·æœ¬ç¼–å·ï¼Œå¦‚ `TCGA-85-6561` |
| `time` | æ•°å€¼å‹ | ç”Ÿå­˜æ—¶é—´æˆ–éšè®¿æ—¶é—´ï¼ˆå•ä½é€šå¸¸æ˜¯æœˆï¼‰ |
| `event` | æ•°å€¼å‹ | ç”Ÿå­˜äº‹ä»¶ï¼ˆ0 = æœªæ­»äº¡ï¼Œ1 = æ­»äº¡ï¼‰ |
| `simplified_stage` | å­—ç¬¦å‹ | ç®€åŒ–çš„åˆ†æœŸåˆ†ç±»ï¼Œå¦‚ `"Early/Local (Stage I-II)"` æˆ– `"Advanced (Stage III)"` |

è¿™ä¸ªè¡¨ç”¨äºï¼š

-   ç”Ÿå­˜åˆ†æï¼ˆå¦‚ Kaplan-Meierï¼‰

-   åˆ†ç»„æ¯”è¾ƒï¼ˆDEG åˆ†æï¼‰

-   WGCNA è¡¨å‹ç›¸å…³æ€§è®¡ç®—

## ğŸ§¬ 2. è¡¨è¾¾æ•°æ®ï¼ˆfinal_data æˆ– expr_dfï¼‰

è¿™æ˜¯ä¸€ä¸ª **RNA-Seq è¡¨è¾¾çŸ©é˜µ**ï¼Œè¡Œä¸ºåŸºå› ï¼Œåˆ—ä¸ºæ ·æœ¬ï¼š

| gene_name | TCGA-90-A4EE | TCGA-85-8049 | TCGA-33-6737...5 | ... |
|-----------|--------------|--------------|------------------|-----|
| TSPAN6    | 8.48         | 8.90         | 24.2             | ... |
| TNMD      | 0.0149       | 0            | 0                | ... |
| DPM1      | 35.1         | 25.3         | 23.2             | ... |

-   æ¯ä¸ªå•å…ƒæ ¼æ˜¯æŸä¸ªåŸºå› åœ¨æŸä¸ªæ ·æœ¬ä¸­çš„è¡¨è¾¾é‡ï¼ˆé€šå¸¸æ˜¯ raw count æˆ– log-transformed countï¼‰

-   ç¬¬ä¸€åˆ—æ˜¯ `gene_name`ï¼Œéœ€è¦è®¾ç½®ä¸ºè¡Œåæ‰èƒ½ç”¨äºåˆ†æ

-   æ€»å…±æœ‰ 563 ä¸ªæ ·æœ¬ï¼Œ6 ä¸ªåŸºå› ï¼ˆè¿™é‡Œåªå±•ç¤ºäº†å‰å‡ è¡Œï¼‰

```{r}
# å»é‡ï¼Œåªä¿ç•™ç¬¬ä¸€ä¸ªå‡ºç°çš„ gene_name


final_data <- final_data[!duplicated(final_data$gene_name), ]

# ä»åŸå§‹æ•°æ®æ¢å¤ gene_name
gene_names <- final_data$gene_name

# å»é™¤ gene_name åˆ—ï¼Œä¿ç•™è¡¨è¾¾å€¼
expr_df <- final_data[, -1]

# è®¾ç½®è¡Œå
rownames(expr_df) <- gene_names

# è½¬æ¢ä¸ºæ•°å€¼çŸ©é˜µ
expr_mat <- as.matrix(expr_df)
mode(expr_mat) <- "numeric"


```

æ£€æµ‹ä¸€ä¸‹

```{r}
sum(is.na(expr_mat))  # æ˜¾ç¤ºæ€»å…±å¤šå°‘ä¸ª NA
```

``` r
2248
```

## ğŸ”§ ä½¿ç”¨ `impute.knn()` è¿›è¡Œ KNN æ’è¡¥

è¿™ä¸ªæ–¹æ³•æ¥è‡ª `impute` åŒ…ï¼Œé€‚ç”¨äº **è¡Œæ˜¯åŸºå› ã€åˆ—æ˜¯æ ·æœ¬** çš„è¡¨è¾¾çŸ©é˜µã€‚å®ƒé€šè¿‡å¯»æ‰¾æ¯ä¸ªç¼ºå¤±å€¼æ‰€åœ¨åŸºå› çš„ K ä¸ªæœ€ç›¸ä¼¼åŸºå› ï¼ˆé‚»å±…ï¼‰ï¼Œç”¨è¿™äº›é‚»å±…çš„éç¼ºå¤±å€¼æ¥å¡«è¡¥ã€‚

### âœ… å®‰è£…å¹¶è½½å…¥åŒ…

```{r}
if (!requireNamespace("impute", quietly = TRUE)) {
    install.packages("impute", repos = "http://bioconductor.org/packages/release/bioc")
}
library(impute)
```

### ğŸ“Œ æ’è¡¥è¡¨è¾¾çŸ©é˜µ

```{r}
# ç¡®ä¿æ˜¯çŸ©é˜µæ ¼å¼


# æ‰§è¡Œ KNN æ’è¡¥
#imputed <- impute.knn(expr_mat, k = 8)  # k å¯è°ƒï¼Œé»˜è®¤æ˜¯10,å¤§äº†ä¼šç‚¸
#expr_mat <- imputed$data  # æå–æ’è¡¥åçš„çŸ©é˜µ
```

``` r
Error:
! cannot allocate vector of size 13.2 Mb
Show Traceback
```

ç”µè„‘å¤ªåƒåœ¾ï¼Œå¸¦ä¸åŠ¨ï¼Œåˆ æ‰å¾—äº†

## ğŸ§  å‚æ•°è¯´æ˜ï¼ˆå¯è°ƒèŠ‚ï¼‰

| å‚æ•°     | é»˜è®¤å€¼ | è¯´æ˜                                 |
|----------|--------|--------------------------------------|
| `k`      | 10     | ç”¨äºæ’è¡¥çš„é‚»å±…æ•°é‡ï¼ˆè¶Šå¤§è¶Šå¹³æ»‘ï¼‰     |
| `rowmax` | 0.5    | è‹¥æŸè¡Œç¼ºå¤±è¶…è¿‡ 50%ï¼Œåˆ™ç”¨æ ·æœ¬å‡å€¼å¡«è¡¥ |
| `colmax` | 0.8    | è‹¥æŸåˆ—ç¼ºå¤±è¶…è¿‡ 80%ï¼Œåˆ™æŠ¥é”™           |
| `maxp`   | 1500   | æ¯æ¬¡æ’è¡¥çš„æœ€å¤§åŸºå› æ•°ï¼Œè¶…è¿‡åˆ™åˆ†å—å¤„ç† |

### ç¬¬äºŒæ­¥ï¼šç§»é™¤å« NA çš„åŸºå› ï¼ˆè¡Œï¼‰

è¿™æ˜¯æœ€å¸¸è§çš„åšæ³•ï¼Œç¡®ä¿æ¯ä¸ªåŸºå› éƒ½æœ‰å®Œæ•´è¡¨è¾¾å€¼ï¼š

```{r}
expr_mat <- expr_mat[complete.cases(expr_mat), ]
```

**è¿‡æ»¤é˜ˆå€¼**ï¼š`cpm > 1` ä¸”è‡³å°‘ `>=3` ä¸ªæ ·æœ¬ï¼Œé€‚åˆæ ·æœ¬é‡ä¸­ç­‰çš„ç ”ç©¶ï¼›è‹¥æ ·æœ¬å°‘ï¼Œå¯æ”¾å®½åˆ° `>=2`ã€‚

```{r}

#### 3. è¿‡æ»¤ä½è¡¨è¾¾åŸºå› ï¼ˆå¸¸è§ç­–ç•¥ï¼šCPM>1 åœ¨è‡³å°‘ n æ ·æœ¬å‡ºç°ï¼‰ ####
library(edgeR)
dge <- DGEList(counts = expr_mat)
keep <- rowSums(cpm(dge) > 1) >= 3   # è‡³å°‘3ä¸ªæ ·æœ¬ï¼Œå¯æŒ‰æ ·æœ¬é‡ä¿®æ”¹
dge <- dge[keep, , keep.lib.sizes=FALSE]
cat("genes retained:", nrow(dge), "\n")
```

``` r
Repeated column names found in count matrix
genes retained: 40685 
```

```{r}
# --------- 2. åŒ¹é…æ ·æœ¬ï¼ˆè¡¨è¾¾çŸ©é˜µåˆ— ä¸ clinical_data$case_idï¼‰ ----------
if(!"case_id" %in% colnames(clinical_data)){
  stop("clinical_data ä¸­æ‰¾ä¸åˆ° case_id åˆ—ï¼Œè¯·ç¡®è®¤åˆ—åã€‚")
}
samples_expr <- colnames(expr_mat)
samples_clin <- clinical_data$case_id
common_samples <- intersect(samples_expr, samples_clin)
cat("è¡¨è¾¾ä¸­æ ·æœ¬æ•°:", length(samples_expr), "\nä¸´åºŠä¸­æ ·æœ¬æ•°:", length(samples_clin), "\nåŒ¹é…åˆ°çš„æ ·æœ¬æ•°:", length(common_samples), "\n")

if(length(common_samples) < 3) stop("åŒ¹é…æ ·æœ¬è¿‡å°‘ï¼Œæ— æ³•ç»§ç»­ã€‚")
```

``` r
è¡¨è¾¾ä¸­æ ·æœ¬æ•°: 562 
ä¸´åºŠä¸­æ ·æœ¬æ•°: 493 
åŒ¹é…åˆ°çš„æ ·æœ¬æ•°: 490 
```

```{r}
# å­é›†åŒ–å¹¶ç¡®ä¿é¡ºåºä¸€è‡´
expr_mat <- expr_mat[, common_samples, drop = FALSE]
clinical_sub <- clinical_data[match(common_samples, clinical_data$case_id), , drop = FALSE]
rownames(clinical_sub) <- clinical_sub$case_id
```

```{r}
# --------- 3. æ’é™¤ Unknown stage çš„æ ·æœ¬ ----------
if(!"simplified_stage" %in% colnames(clinical_sub)){
  stop("clinical_data ä¸­æ²¡æœ‰ simplified_stage åˆ—ï¼Œè¯·å…ˆç”Ÿæˆã€‚")
}
keep_idx <- !is.na(clinical_sub$simplified_stage) & clinical_sub$simplified_stage != "Unknown"
expr_mat <- expr_mat[, keep_idx, drop = FALSE]
clinical_sub <- clinical_sub[keep_idx, , drop = FALSE]
cat("ç”¨äºå·®å¼‚åˆ†æçš„æ ·æœ¬æ•°:", ncol(expr_mat), "\nå„ç»„åˆ†å¸ƒ:\n")
print(table(clinical_sub$simplified_stage))
```

``` r
ç”¨äºå·®å¼‚åˆ†æçš„æ ·æœ¬æ•°: 425 
å„ç»„åˆ†å¸ƒ:

    Advanced (Stage III) Early/Local (Stage I-II) 
                      76                      349 
                      
```

**å½’ä¸€åŒ–**ï¼šTMMï¼ˆedgeRï¼‰æˆ– DESeq2 å†…ç½®æ–¹æ³•å‡å¯ï¼›DESeq2 æ›´é€‚åˆç›´æ¥åšå·®å¼‚åˆ†æï¼ˆåŸå§‹æ•´æ•°è®¡æ•°ï¼‰ã€‚

```{r}
# --------- 4. ä½è¡¨è¾¾åŸºå› è¿‡æ»¤ï¼ˆedgeR CPMï¼‰ ----------
dge <- DGEList(counts = expr_mat)
keep_genes <- rowSums(cpm(dge) > 1) >= 3   # è‡³å°‘ 3 ä¸ªæ ·æœ¬ CPM>1ï¼›å¯æ ¹æ®æ ·æœ¬é‡è°ƒæ•´
dge <- dge[keep_genes, , keep.lib.sizes = FALSE]
cat("è¿‡æ»¤åä¿ç•™åŸºå› æ•°:", nrow(dge), "\n")
```

``` r
è¿‡æ»¤åä¿ç•™åŸºå› æ•°: 37156 
```

```{r}
# --------- 5. æ— åå˜é‡ï¼ˆåªæ ¹æ® simplified_stage åˆ†ç»„ï¼‰ ----------
clinical_sub$simplified_stage <- factor(clinical_sub$simplified_stage)
if ("Early/Local (Stage I-II)" %in% levels(clinical_sub$simplified_stage)) {
  clinical_sub$simplified_stage <- relevel(clinical_sub$simplified_stage, ref = "Early/Local (Stage I-II)")
}

# è®¾è®¡å…¬å¼
design_formula <- ~ simplified_stage
cat("ä½¿ç”¨çš„è®¾è®¡å…¬å¼ï¼š", format(design_formula), "\n")

expr_int <- apply(dge$counts, 2, as.integer)
rownames(expr_int) <- rownames(dge$counts)
dds <- DESeqDataSetFromMatrix(
  countData = expr_int,
  colData = clinical_sub,
  design = design_formula
)

```

```{r}
# --------- 6. è¿è¡Œ DESeq2 ----------
dds <- DESeq(dds)

# --------- 7. è·å–å·®å¼‚ç»“æœ ----------
contrast_vec <- c("simplified_stage", "Advanced (Stage III)", "Early/Local (Stage I-II)")
res_raw <- results(dds, contrast = contrast_vec)

if (requireNamespace("apeglm", quietly = TRUE)) {
  resLFC <- lfcShrink(
  dds,
  coef = "simplified_stage_Advanced..Stage.III._vs_Early.Local..Stage.I.II.",
  type = "apeglm"
)

} else {
  message("æœªå®‰è£… apeglmï¼Œå°†è¿”å›æœªæ”¶ç¼©çš„ç»“æœã€‚")
  resLFC <- res_raw
}

res_df <- as.data.frame(resLFC)
res_df$gene <- rownames(res_df)
res_df <- res_df[order(res_df$padj), ]

write.csv(res_df, "DEG_Advanced_vs_Early.csv", row.names = FALSE)
cat("å·®å¼‚åˆ†æç»“æœå·²ä¿å­˜ï¼šDEG_Advanced_vs_Early.csv\n")
```

```{r}
# --------- 8. ç­›é€‰æ˜¾è‘—åŸºå›  ----------
sig <- subset(res_df, !is.na(padj) & padj < 0.1 & abs(log2FoldChange) >= 0.3)
cat("æ˜¾è‘— DEG æ•°é‡:", nrow(sig), "\n")
write.csv(sig, "significant_DEGs.csv", row.names = FALSE)
```

æ˜¾è‘— DEG æ•°é‡: 26

```{r}
# --------- 9. ç«å±±å›¾ ----------
res_df$signif <- ifelse(!is.na(res_df$padj) & res_df$padj < 0.1 & abs(res_df$log2FoldChange) >= 0.3, "yes", "no")

library(ggplot2)
p_volcano <- ggplot(res_df, aes(x = log2FoldChange, y = -log10(pvalue), color = signif)) +
  geom_point(alpha = 0.6, size = 1.2) +
  scale_color_manual(values = c("no" = "grey70", "yes" = "red")) +
  theme_minimal() +
  labs(title = "Volcano Plot (Advanced vs Early)", x = "log2 Fold Change", y = "-log10(p-value)")

ggsave("Volcano_DEG.png", p_volcano, width = 7, height = 5, dpi = 300)
```

-   å°‘é‡ DEG â†’ åŸºäºå®ƒä»¬ç›´æ¥èšç±»**ä¸ç¨³å¥**ï¼ˆå—å•ä¸ªåŸºå› å¼ºå½±å“ï¼‰ã€‚

    ä¼˜å…ˆåš**é™ç»´ / èšåˆ / æ¨¡å—åŒ–ç‰¹å¾**ï¼ˆæ¯”å¦‚ WGCNA æ¨¡å— eigengeneã€GSVA è·¯å¾„å¾—åˆ†ã€æˆ– top-variance åŸºå› é›†åˆï¼‰å†èšç±»ã€‚

    è¦åŒæ—¶åš**æ— ç›‘ç£ï¼ˆå‘ç°äºšå‹ï¼‰ä¸æœ‰ç›‘ç£/éªŒè¯ï¼ˆæŒ‰ stage åˆ†å±‚æˆ–æ£€éªŒç°‡ä¸åˆ†æœŸ/ç”Ÿå­˜çš„å…³è”ï¼‰**ï¼Œä¸¤è€…äº’ä¸ºè¡¥å……ã€‚

    ä½¿ç”¨**ç¨³å®šæ€§è¯„ä¼°**ï¼ˆsilhouette, consensus clustering, bootstrapï¼‰æ¥åˆ¤å®šç°‡ç»“æœæ˜¯å¦å¯é 

![](images/Volcano_DEG.png)

## 1) **åŸºäº WGCNA æ¨¡å— Eigengenes å¯¹æ ·æœ¬èšç±»**

**ç†ç”±**ï¼šWGCNA æŠŠåŸºå› é›†åˆæˆæ¨¡å—ï¼Œå†ç”¨æ¨¡å— eigengeneä½œä¸ºæ ·æœ¬ç‰¹å¾ï¼Œç»´åº¦ä½ã€ä¿¡å™ªæ¯”é«˜ï¼Œé€‚åˆæ ·æœ¬èšç±»ä¸”æ˜“è§£é‡Šä¸ºç”Ÿç‰©å­¦æ¨¡å—ã€‚\
**ä¼˜ç‚¹**ï¼šæ¯”ç›´æ¥ç”¨å‡ åä¸ª DEG æ›´ç¨³å¥ï¼›ä¾¿äºè§£é‡Šï¼ˆæ¨¡å— â†’ é€šè·¯ï¼‰

```{r}
library(WGCNA)
options(stringsAsFactors = FALSE)
allowWGCNAThreads()

# VST è½¬æ¢
vsd <- vst(dds, blind = TRUE)
vst_mat <- assay(vsd)

# é€‰æ‹©é«˜å˜åŸºå› 
top_var_genes <- order(apply(vst_mat, 1, var), decreasing = TRUE)[1:5000]
datExpr <- t(vst_mat[top_var_genes, ])

# æ£€æŸ¥ç¼ºå¤±å€¼
gsg <- goodSamplesGenes(datExpr, verbose = 3)
if (!gsg$allOK) datExpr <- datExpr[gsg$goodSamples, gsg$goodGenes]

# è®¡ç®—è½¯é˜ˆå€¼
powers <- c(1:20)
sft <- pickSoftThreshold(datExpr, powerVector = powers, verbose = 5)
softPower <- ifelse(any(sft$fitIndices[,2] > 0.8),
                    min(sft$fitIndices$Power[sft$fitIndices[,2] > 0.8]),
                    sft$fitIndices$Power[which.max(sft$fitIndices[,2])])

cat("Chosen softPower =", softPower, "\n")

# æ„å»ºç½‘ç»œ
net <- blockwiseModules(datExpr, power = softPower,
                        TOMType = "unsigned",
                        minModuleSize = 30,
                        mergeCutHeight = 0.25,
                        numericLabels = TRUE,
                        pamRespectsDendro = FALSE,
                        saveTOMs = FALSE,
                        verbose = 3)

MEs <- net$MEs
moduleColors <- labels2colors(net$colors)
```

```{r}
# æå–æ ·æœ¬é¡ºåº
sampleNames <- rownames(datExpr)
head(sampleNames)

# ä» clinical_sub æå– simplified_stage
trait_df <- clinical_sub %>%
  dplyr::filter(case_id %in% sampleNames) %>%
  dplyr::arrange(match(case_id, sampleNames))

# äºŒå€¼åŒ– simplified_stage
trait <- ifelse(trait_df$simplified_stage == "Advanced (Stage III)", 1, 0)

length(trait)
length(sampleNames)
```

```{r}
#  datExpr å·²ç»æ˜¯è¡Œ = æ ·æœ¬, åˆ— = åŸºå› 
sampleNames <- rownames(datExpr)

# ç¡®ä¿ simplified_stage å­˜åœ¨ä¸”æ—  NA
clinical_sub <- clinical_data %>%
  filter(case_id %in% sampleNames & !is.na(simplified_stage)) %>%
  arrange(match(case_id, sampleNames))

# æ£€æŸ¥åŒ¹é…æƒ…å†µ
cat("è¡¨è¾¾çŸ©é˜µæ ·æœ¬æ•°:", nrow(datExpr), "\nä¸´åºŠåŒ¹é…æ•°:", nrow(clinical_sub), "\n")

# äºŒå€¼åŒ– simplified_stage
trait <- ifelse(clinical_sub$simplified_stage == "Advanced (Stage III)", 1, 0)

# æ£€æŸ¥ trait é•¿åº¦æ˜¯å¦åŒ¹é…
length(trait)
length(sampleNames)
```

```{r}
moduleTraitCor <- cor(MEs, trait, use = "p")
moduleTraitPvalue <- corPvalueStudent(moduleTraitCor, nSamples = nrow(datExpr))

# ç»˜åˆ¶ç›¸å…³çƒ­å›¾
textMatrix <- paste(signif(moduleTraitCor, 2), "\n(",
                    signif(moduleTraitPvalue, 1), ")", sep = "")
dim(textMatrix) <- dim(moduleTraitCor)

labeledHeatmap(Matrix = moduleTraitCor,
               xLabels = "Simplified Stage (Advanced=1)",
               yLabels = names(MEs),
               ySymbols = names(MEs),
               colorLabels = FALSE,
               colors = blueWhiteRed(50),
               textMatrix = textMatrix,
               setStdMargins = FALSE,
               cex.text = 0.7,
               zlim = c(-1,1),
               main = "Module-trait relationships")
```

![](plot-10.png)

```{r}
length(trait)
nrow(datExpr)
```

``` r
> length(trait)
+ nrow(datExpr)
[1] 425
[1] 425
```

```{r}
# ==============================
# ç¬¬ 8 æ­¥ï¼šæå–æ˜¾è‘—æ¨¡å— + DEG å¹¶é›†
# ==============================

# è®¾ç½®æ˜¾è‘—é˜ˆå€¼
sig_modules <- rownames(moduleTraitCor)[abs(moduleTraitCor[,1]) > 0.3 & moduleTraitPvalue[,1] < 0.05]

cat("æ˜¾è‘—æ¨¡å—:", sig_modules, "\n")

# è‹¥æ²¡æœ‰æ˜¾è‘—æ¨¡å—ï¼Œå¯æ”¾å®½é˜ˆå€¼æˆ–é€‰å– top 1 æ¨¡å—
if (length(sig_modules) == 0) {
  sig_modules <- rownames(moduleTraitCor)[order(abs(moduleTraitCor[,1]), decreasing = TRUE)[1]]
  cat("æœªæ‰¾åˆ°æ˜¾è‘—æ¨¡å—ï¼Œè‡ªåŠ¨é€‰æ‹©æœ€é«˜ç›¸å…³æ¨¡å—:", sig_modules, "\n")
}

# æå–è¿™äº›æ¨¡å—çš„åŸºå› 
sig_genes <- names(net$colors)[net$colors %in% match(sig_modules, rownames(moduleTraitCor))]

cat("æ˜¾è‘—æ¨¡å—åŒ…å«åŸºå› æ•°:", length(sig_genes), "\n")

# å– DEG çš„æ˜¾è‘—åŸºå› 
DEG_genes <- rownames(resLFC[which(resLFC$padj < 0.2 & abs(resLFC$log2FoldChange) >= 0.5), ])

cat("å·®å¼‚åŸºå› æ•°:", length(DEG_genes), "\n")

# å¹¶é›†
gene_union <- union(sig_genes, DEG_genes)
cat("ç”¨äºèšç±»åˆ†æçš„åŸºå› æ•°:", length(gene_union), "\n")

expr_for_cluster <- t(vst_mat[intersect(rownames(vst_mat), gene_union), ])

```

![](plot-11.png)

```{r}
# ==============================
# ç¬¬ 9 æ­¥ï¼šK-means èšç±» + è‚˜ç‚¹æ³•é€‰æ‹© k
# ==============================

library(factoextra)

# è®¡ç®—æ€»å¹³æ–¹è¯¯å·®ï¼ˆSSEï¼‰
fviz_nbclust(expr_for_cluster, kmeans, method = "wss") +
  ggtitle("Elbow method for optimal k")
```

```{r}
# ï¼ˆæ ¹æ®è‚˜ç‚¹é€‰æ‹© k å€¼ï¼Œä¾‹å¦‚ k = 2 æˆ– 3ï¼‰
set.seed(123)
k_opt <- 4  # ä½ å¯ä»¥æ ¹æ®ä¸Šå›¾è‚˜ç‚¹ä¿®æ”¹
km_res <- kmeans(scale(expr_for_cluster), centers = k_opt, nstart = 25)

# å°†èšç±»ç»“æœé™„åŠ åˆ°ä¸´åºŠæ•°æ®
clinical_cluster <- clinical_sub
clinical_cluster$cluster <- factor(km_res$cluster)
table(clinical_cluster$cluster)

```

``` r

  1   2   3   4 
125 131  84  85 
```

```{r}
# ==============================
# ç¬¬ 10 æ­¥ï¼šç»˜åˆ¶çƒ­å›¾
# ==============================
library(pheatmap)

# é€‰æ‹©å‰ 100 ä¸ªæœ€å…·æ–¹å·®åŸºå› ä»¥ä¾¿å¯è§†åŒ–ï¼ˆå¦åˆ™å¤ªå¤šï¼‰
top_genes_vis <- order(apply(expr_for_cluster, 2, var), decreasing = TRUE)[1:100]

annotation_col <- data.frame(
  Stage = clinical_cluster$simplified_stage,
  Cluster = clinical_cluster$cluster
)
rownames(annotation_col) <- rownames(expr_for_cluster)

pheatmap(
  t(expr_for_cluster[, top_genes_vis]),
  annotation_col = annotation_col,
  show_colnames = FALSE,
  show_rownames = FALSE,
  scale = "row",
  clustering_method = "ward.D2",
  main = "DEG + WGCNA modules heatmap"
)

```

-   ![](plot-15.png)

-   **DESeq2**ï¼šåªå¾—åˆ°å‡ åä¸ªå·®å¼‚åŸºå›  â†’ è¯´æ˜ç»„é—´å·®å¼‚æ•´ä½“è¾ƒå¼±ï¼›

    **WGCNA**ï¼šæ²¡æ‰¾åˆ°æ˜¾è‘—ç›¸å…³æ¨¡å—ï¼Œä½†å‘ç°äº†ä¸€ä¸ªæœ€ç›¸å…³æ¨¡å—ï¼ˆME8ï¼Œ226ä¸ªåŸºå› ï¼‰ï¼›

    **çƒ­å›¾ç»“æœ**ï¼šgroup åˆ†ç»„ä¸èƒ½æ¸…æ™°åŒºåˆ†æ ·æœ¬è¡¨è¾¾æ¨¡å¼

    **ç»“è®º**ï¼šåˆ†ç»„ï¼ˆå¯èƒ½æ˜¯é«˜ä½ã€ç—…ä¾‹/å¯¹ç…§ï¼‰åœ¨è¡¨è¾¾å±‚é¢ä¸Šä¸å¤Ÿæ˜¾è‘—ï¼›

    **æ­£ç¡®é€‰æ‹©**ï¼šä¸å†ç”¨â€œç›‘ç£èšç±»â€ï¼ˆå³å¼ºè¡ŒæŒ‰ group åŒºåˆ†ï¼‰ï¼Œè€Œæ”¹ä¸º **æ— ç›‘ç£èšç±»** æˆ–ä½¿ç”¨ **å¤–éƒ¨æ•°æ®åº“ç­›åŸºå› ï¼ˆå¦‚ GEPIA / GVES / TCGAï¼‰**ã€‚

éªŒè¯ä½ çš„åˆ†ç»„ï¼ˆå¦‚ `simplified_stage` ä¸­çš„ â€œEarly/Local (Stage I-II)â€ vs â€œAdvanced (Stage III)â€ï¼‰æ˜¯å¦èƒ½åŒºåˆ†æ ·æœ¬çš„è¡¨è¾¾æ¨¡å¼ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‡ ç§æ–¹æ³•è¿›è¡Œ**æ— ç›‘ç£ä¸æœ‰ç›‘ç£çš„éªŒè¯**ï¼š

## âœ… æ–¹æ³•ä¸€ï¼šä¸»æˆåˆ†åˆ†æï¼ˆPCAï¼‰

**ç›®çš„**ï¼šæŸ¥çœ‹ä¸åŒåˆ†ç»„çš„æ ·æœ¬åœ¨ä¸»æˆåˆ†ç©ºé—´ä¸­æ˜¯å¦èšé›†æˆ–åˆ†ç¦»ã€‚

r

```{r}
# ä½¿ç”¨ VST è½¬æ¢åçš„è¡¨è¾¾çŸ©é˜µ
vsd <- vst(dds, blind = FALSE)
mat_vst <- assay(vsd)

# PCA
pca <- prcomp(t(mat_vst))
pc_df <- data.frame(PC1 = pca$x[,1], PC2 = pca$x[,2],
                    Stage = clinical_sub$simplified_stage)
ggplot(pc_df, aes(x = PC1, y = PC2, color = Stage)) +
  geom_point(size = 2) +
  theme_minimal() +
  labs(title = "PCA: Expression Pattern by Stage")
```

![](plot-18.png)

**è§£è¯»**ï¼š

-   ä¸åŒåˆ†ç»„çš„æ ·æœ¬åœ¨ PCA å›¾ä¸­ä¸å½¢æˆæ˜æ˜¾åˆ†ç¦»çš„ç°‡ï¼Œè¯´æ˜åˆ†ç»„ä¸èƒ½è¾ƒå¥½åœ°åŒºåˆ†è¡¨è¾¾æ¨¡å¼ã€‚

-   æ··åœ¨ä¸€èµ·ï¼Œè¯´æ˜è¡¨è¾¾å·®å¼‚ä¸æ˜æ˜¾æˆ–å™ªå£°è¾ƒå¤§ã€‚

## ğŸ§¬ ä¸‰ã€æ— ç›‘ç£èšç±»çš„ä¸¤ç§å¸¸ç”¨æ–¹æ³•

### 1ï¸âƒ£ ç›´æ¥è·³è¿‡WGCNAWGCNA

```{r}
library(pheatmap)
library(factoextra)

# ä½¿ç”¨æ ·æœ¬è¡¨è¾¾çŸ©é˜µçš„è½¬ç½® (æ ·æœ¬ Ã— åŸºå› )


# ç”¨è‚˜éƒ¨æ³•ç¡®å®šæœ€ä½³K
fviz_nbclust(datExpr, kmeans, method = "wss")

# èšç±»
set.seed(123)
km_res <- kmeans(datExpr, centers = 4, nstart = 25)
fviz_cluster(km_res, data = datExpr)
```

```{r}
topVarGenes <- order(apply(mat_vst, 1, var), decreasing = TRUE)[1:1000]
common_samples <- intersect(common_samples, colnames(mat_vst))

expr_topVar <- mat_vst[topVarGenes, common_samples]

# 2. æ ‡å‡†åŒ–
expr_topVar <- t(scale(t(expr_topVar)))

rownames(annotation_col) <- colnames(expr_topVar)

pheatmap(expr_topVar,
         annotation_col = annotation_col,
         clustering_distance_cols = "euclidean",
         clustering_method = "ward.D2",
         show_colnames = FALSE,
         show_rownames = FALSE,
         main = "Unsupervised clustering of top variable genes")

```

è¿™ä¸€æ­¥å¯ä»¥å¸®åŠ©ä½ **å‘ç°æ–°çš„æ ·æœ¬äºšå‹ç»“æ„**ã€‚

![](plot-23.png)

![](plot-27.png)

åé¢æ‰“ç®—åšgvesçš„ï¼Œä½†æ˜¯æ„Ÿè§‰è¿™ä¸ªæ•°æ®åšè¿™ä¸ªå¯èƒ½æ²¡ä»€ä¹ˆæ„ä¹‰æ‹‰åˆ°å¾—äº†