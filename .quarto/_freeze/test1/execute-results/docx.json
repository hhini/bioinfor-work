{
  "hash": "e36ad5d9b181cfcef5c442fb5ec29f58",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: å¤šå…ƒæ•°æ®åˆ†æä½œä¸š\nauthors:\n  - name: å‘¨æ° 113120230073\n    affiliation: The GanNan medical University \n    roles: writing\n    corresponding: true\nbibliography: references.bib\n---\n\n# å¤šå…ƒæ•°æ®åˆ†æä½œä¸š\n\n## ğŸ§¬ TCGA-LUSC é¡¹ç›®æ•°æ®ç®€æŠ¥\n\n### ğŸ“Œ é¡¹ç›®åŸºæœ¬ä¿¡æ¯\n\n| é¡¹ç›®å­—æ®µ            | å†…å®¹                                         |\n|---------------------|----------------------------------------------|\n| **Project ID**      | TCGA-LUSC                                    |\n| **dbGaP Accession** | phs000178                                    |\n| **é¡¹ç›®åç§°**        | è‚ºé³çŠ¶ç»†èƒç™Œï¼ˆLung Squamous Cell Carcinomaï¼‰ |\n| **ç–¾ç—…ç±»å‹**        | 2ç§ç–¾ç—…ç±»å‹ï¼ˆåŒ…æ‹¬è‚ºé³ç™ŒåŠç›¸å…³äºšå‹ï¼‰          |\n| **ä¸»ç«™ç‚¹**          | æ”¯æ°”ç®¡å’Œè‚ºï¼ˆBronchus and Lungï¼‰              |\n| **æ‰€å±è®¡åˆ’**        | TCGAï¼ˆç™Œç—‡åŸºå› ç»„å›¾è°±è®¡åˆ’ï¼‰                   |\n\n### ğŸ§ª æ•°æ®ç±»å‹ä¸å¯ç”¨æ€§\n\n| æ•°æ®ç±»å‹    | æ ·æœ¬æ•°é‡ | è¦†ç›–ç‡ | å¤‡æ³¨è¯´æ˜                            |\n|-------------|----------|--------|-------------------------------------|\n| **RNA-Seq** | 501      | 99.4%  | é«˜è¦†ç›–ç‡ï¼Œé€‚ç”¨äºå·®å¼‚è¡¨è¾¾åˆ†æï¼ˆDEGï¼‰ |\n\n## ç¬¬ä¸€æ­¥ï¼šè½½å…¥æ•°æ®\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#### 1. å®‰è£…/è½½å…¥å¿…è¦åŒ… ####\n#required_pkgs <- c(\"DESeq2\",\"edgeR\",\"limma\",\"cluster\",\"factoextra\",\"NbClust\",\n #                  \"pheatmap\",\"RColorBrewer\",\"ggplot2\",\"dplyr\",\"sva\",\"BiocManager\")\n#for(pkg in required_pkgs){\n # if(!requireNamespace(pkg, quietly = TRUE)){\n  #  if(pkg == \"BiocManager\") install.packages(\"BiocManager\")\n  #  else if(pkg %in% c(\"DESeq2\",\"edgeR\",\"limma\",\"sva\"))\n   #   BiocManager::install(pkg, ask = FALSE, update = FALSE)\n  #  else install.packages(pkg)\n  #}\n # library(pkg, character.only = TRUE)\n#}\n# ---- 1. è½½å…¥/å®‰è£…å¿…è¦åŒ… ----\npkgs_cran <- c(\"pheatmap\",\"ggplot2\",\"dplyr\",\"RColorBrewer\",\"factoextra\",\"cluster\",\"NbClust\")\npkgs_bioc  <- c(\"DESeq2\",\"edgeR\",\"apeglm\",\"WGCNA\")\n\nfor(p in pkgs_cran){\n  if(!requireNamespace(p, quietly = TRUE)) install.packages(p)\n  library(p, character.only = TRUE)\n}\nif(!requireNamespace(\"BiocManager\", quietly = TRUE)) install.packages(\"BiocManager\")\nfor(p in pkgs_bioc){\n  if(!requireNamespace(p, quietly = TRUE)) BiocManager::install(p, ask = FALSE, update = FALSE)\n  library(p, character.only = TRUE)\n}\n```\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(readr)\nfinal_data <- read_csv(\"E:/acode/wsl/data2/GDCdata/TCGA-LUSC/rnaexp.csv\", col_names = TRUE)\nfinal_data <- final_data[ , -1]  # åˆ é™¤ç¬¬ä¸€åˆ—\n\nclinical_data <- read_csv(\"E:/acode/wsl/data2/GDCdata/TCGA-LUSC/clinical_metadata.csv\", col_names = TRUE)\n```\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#|echo:true\nhead(clinical_data)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 6 Ã— 4\n  case_id       time event simplified_stage        \n  <chr>        <dbl> <dbl> <chr>                   \n1 TCGA-85-6561    24     0 Early/Local (Stage I-II)\n2 TCGA-37-5819   103     0 Advanced (Stage III)    \n3 TCGA-77-8008  2639     1 Early/Local (Stage I-II)\n4 TCGA-56-8083     2     0 Early/Local (Stage I-II)\n5 TCGA-56-A4ZJ    25     0 Early/Local (Stage I-II)\n6 TCGA-85-7710     0     0 Early/Local (Stage I-II)\n```\n\n\n:::\n\n```{.r .cell-code}\nhead(final_data)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 6 Ã— 563\n  gene_name `TCGA-90-A4EE` `TCGA-85-8049` `TCGA-33-6737...5` `TCGA-39-5016`\n  <chr>              <dbl>          <dbl>              <dbl>          <dbl>\n1 TSPAN6            8.48             8.90              24.2         21.0   \n2 TNMD              0.0149           0                  0            0.0587\n3 DPM1             35.1             25.3               23.2         63.1   \n4 SCYL3             3.91             2.58               1.29         3.36  \n5 C1orf112          3.76             2.85               2.62         2.77  \n6 FGR              14.2              9.12               7.31         3.78  \n# â„¹ 558 more variables: `TCGA-56-8304` <dbl>, `TCGA-92-8063` <dbl>,\n#   `TCGA-22-4593...9` <dbl>, `TCGA-43-8115` <dbl>, `TCGA-22-4599` <dbl>,\n#   `TCGA-60-2712` <dbl>, `TCGA-21-1080` <dbl>, `TCGA-43-5670...14` <dbl>,\n#   `TCGA-33-AASI` <dbl>, `TCGA-56-7582...16` <dbl>, `TCGA-58-8388` <dbl>,\n#   `TCGA-56-7822` <dbl>, `TCGA-56-7579...19` <dbl>, `TCGA-22-1016...20` <dbl>,\n#   `TCGA-46-6025` <dbl>, `TCGA-60-2715` <dbl>, `TCGA-22-1005...23` <dbl>,\n#   `TCGA-L3-A4E7` <dbl>, `TCGA-60-2709...25` <dbl>, `TCGA-77-7141` <dbl>, â€¦\n```\n\n\n:::\n:::\n\n\n## ğŸ§¾ 1. ä¸´åºŠæ•°æ®ï¼ˆclinical_dataï¼‰\n\nè¿™æ˜¯ä¸€ä¸ªåŒ…å« **æ ·æœ¬åŸºæœ¬ä¿¡æ¯å’Œåˆ†æœŸåˆ†ç±»** çš„è¡¨æ ¼ï¼š\n\n| åˆ—å | ç±»å‹ | è¯´æ˜ |\n|------------------------|------------------------|------------------------|\n| `case_id` | å­—ç¬¦å‹ | TCGA æ ·æœ¬ç¼–å·ï¼Œå¦‚ `TCGA-85-6561` |\n| `time` | æ•°å€¼å‹ | ç”Ÿå­˜æ—¶é—´æˆ–éšè®¿æ—¶é—´ï¼ˆå•ä½é€šå¸¸æ˜¯æœˆï¼‰ |\n| `event` | æ•°å€¼å‹ | ç”Ÿå­˜äº‹ä»¶ï¼ˆ0 = æœªæ­»äº¡ï¼Œ1 = æ­»äº¡ï¼‰ |\n| `simplified_stage` | å­—ç¬¦å‹ | ç®€åŒ–çš„åˆ†æœŸåˆ†ç±»ï¼Œå¦‚ `\"Early/Local (Stage I-II)\"` æˆ– `\"Advanced (Stage III)\"` |\n\nè¿™ä¸ªè¡¨ç”¨äºï¼š\n\n-   ç”Ÿå­˜åˆ†æï¼ˆå¦‚ Kaplan-Meierï¼‰\n\n-   åˆ†ç»„æ¯”è¾ƒï¼ˆDEG åˆ†æï¼‰\n\n-   WGCNA è¡¨å‹ç›¸å…³æ€§è®¡ç®—\n\n## ğŸ§¬ 2. è¡¨è¾¾æ•°æ®ï¼ˆfinal_data æˆ– expr_dfï¼‰\n\nè¿™æ˜¯ä¸€ä¸ª **RNA-Seq è¡¨è¾¾çŸ©é˜µ**ï¼Œè¡Œä¸ºåŸºå› ï¼Œåˆ—ä¸ºæ ·æœ¬ï¼š\n\n| gene_name | TCGA-90-A4EE | TCGA-85-8049 | TCGA-33-6737...5 | ... |\n|-----------|--------------|--------------|------------------|-----|\n| TSPAN6    | 8.48         | 8.90         | 24.2             | ... |\n| TNMD      | 0.0149       | 0            | 0                | ... |\n| DPM1      | 35.1         | 25.3         | 23.2             | ... |\n\n-   æ¯ä¸ªå•å…ƒæ ¼æ˜¯æŸä¸ªåŸºå› åœ¨æŸä¸ªæ ·æœ¬ä¸­çš„è¡¨è¾¾é‡ï¼ˆé€šå¸¸æ˜¯ raw count æˆ– log-transformed countï¼‰\n\n-   ç¬¬ä¸€åˆ—æ˜¯ `gene_name`ï¼Œéœ€è¦è®¾ç½®ä¸ºè¡Œåæ‰èƒ½ç”¨äºåˆ†æ\n\n-   æ€»å…±æœ‰ 563 ä¸ªæ ·æœ¬ï¼Œ6 ä¸ªåŸºå› ï¼ˆè¿™é‡Œåªå±•ç¤ºäº†å‰å‡ è¡Œï¼‰\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# å»é‡ï¼Œåªä¿ç•™ç¬¬ä¸€ä¸ªå‡ºç°çš„ gene_name\n\n\nfinal_data <- final_data[!duplicated(final_data$gene_name), ]\n\n# ä»åŸå§‹æ•°æ®æ¢å¤ gene_name\ngene_names <- final_data$gene_name\n\n# å»é™¤ gene_name åˆ—ï¼Œä¿ç•™è¡¨è¾¾å€¼\nexpr_df <- final_data[, -1]\n\n# è®¾ç½®è¡Œå\nrownames(expr_df) <- gene_names\n\n# è½¬æ¢ä¸ºæ•°å€¼çŸ©é˜µ\nexpr_mat <- as.matrix(expr_df)\nmode(expr_mat) <- \"numeric\"\n```\n:::\n\n\næ£€æµ‹ä¸€ä¸‹\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsum(is.na(expr_mat))  # æ˜¾ç¤ºæ€»å…±å¤šå°‘ä¸ª NA\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 2248\n```\n\n\n:::\n:::\n\n\n``` r\n2248\n```\n\n## ğŸ”§ ä½¿ç”¨ `impute.knn()` è¿›è¡Œ KNN æ’è¡¥\n\nè¿™ä¸ªæ–¹æ³•æ¥è‡ª `impute` åŒ…ï¼Œé€‚ç”¨äº **è¡Œæ˜¯åŸºå› ã€åˆ—æ˜¯æ ·æœ¬** çš„è¡¨è¾¾çŸ©é˜µã€‚å®ƒé€šè¿‡å¯»æ‰¾æ¯ä¸ªç¼ºå¤±å€¼æ‰€åœ¨åŸºå› çš„ K ä¸ªæœ€ç›¸ä¼¼åŸºå› ï¼ˆé‚»å±…ï¼‰ï¼Œç”¨è¿™äº›é‚»å±…çš„éç¼ºå¤±å€¼æ¥å¡«è¡¥ã€‚\n\n### âœ… å®‰è£…å¹¶è½½å…¥åŒ…\n\n\n::: {.cell}\n\n```{.r .cell-code}\nif (!requireNamespace(\"impute\", quietly = TRUE)) {\n    install.packages(\"impute\", repos = \"http://bioconductor.org/packages/release/bioc\")\n}\nlibrary(impute)\n```\n:::\n\n\n### ğŸ“Œ æ’è¡¥è¡¨è¾¾çŸ©é˜µ\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# ç¡®ä¿æ˜¯çŸ©é˜µæ ¼å¼\n\n\n# æ‰§è¡Œ KNN æ’è¡¥\n#imputed <- impute.knn(expr_mat, k = 8)  # k å¯è°ƒï¼Œé»˜è®¤æ˜¯10,å¤§äº†ä¼šç‚¸\n#expr_mat <- imputed$data  # æå–æ’è¡¥åçš„çŸ©é˜µ\n```\n:::\n\n\n``` r\nError:\n! cannot allocate vector of size 13.2 Mb\nShow Traceback\n```\n\nç”µè„‘å¤ªåƒåœ¾ï¼Œå¸¦ä¸åŠ¨ï¼Œåˆ æ‰å¾—äº†\n\n## ğŸ§  å‚æ•°è¯´æ˜ï¼ˆå¯è°ƒèŠ‚ï¼‰\n\n| å‚æ•°     | é»˜è®¤å€¼ | è¯´æ˜                                 |\n|----------|--------|--------------------------------------|\n| `k`      | 10     | ç”¨äºæ’è¡¥çš„é‚»å±…æ•°é‡ï¼ˆè¶Šå¤§è¶Šå¹³æ»‘ï¼‰     |\n| `rowmax` | 0.5    | è‹¥æŸè¡Œç¼ºå¤±è¶…è¿‡ 50%ï¼Œåˆ™ç”¨æ ·æœ¬å‡å€¼å¡«è¡¥ |\n| `colmax` | 0.8    | è‹¥æŸåˆ—ç¼ºå¤±è¶…è¿‡ 80%ï¼Œåˆ™æŠ¥é”™           |\n| `maxp`   | 1500   | æ¯æ¬¡æ’è¡¥çš„æœ€å¤§åŸºå› æ•°ï¼Œè¶…è¿‡åˆ™åˆ†å—å¤„ç† |\n\n### ç¬¬äºŒæ­¥ï¼šç§»é™¤å« NA çš„åŸºå› ï¼ˆè¡Œï¼‰\n\nè¿™æ˜¯æœ€å¸¸è§çš„åšæ³•ï¼Œç¡®ä¿æ¯ä¸ªåŸºå› éƒ½æœ‰å®Œæ•´è¡¨è¾¾å€¼ï¼š\n\n\n::: {.cell}\n\n```{.r .cell-code}\nexpr_mat <- expr_mat[complete.cases(expr_mat), ]\n```\n:::\n\n\n**è¿‡æ»¤é˜ˆå€¼**ï¼š`cpm > 1` ä¸”è‡³å°‘ `>=3` ä¸ªæ ·æœ¬ï¼Œé€‚åˆæ ·æœ¬é‡ä¸­ç­‰çš„ç ”ç©¶ï¼›è‹¥æ ·æœ¬å°‘ï¼Œå¯æ”¾å®½åˆ° `>=2`ã€‚\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#### 3. è¿‡æ»¤ä½è¡¨è¾¾åŸºå› ï¼ˆå¸¸è§ç­–ç•¥ï¼šCPM>1 åœ¨è‡³å°‘ n æ ·æœ¬å‡ºç°ï¼‰ ####\nlibrary(edgeR)\ndge <- DGEList(counts = expr_mat)\nkeep <- rowSums(cpm(dge) > 1) >= 3   # è‡³å°‘3ä¸ªæ ·æœ¬ï¼Œå¯æŒ‰æ ·æœ¬é‡ä¿®æ”¹\ndge <- dge[keep, , keep.lib.sizes=FALSE]\ncat(\"genes retained:\", nrow(dge), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\ngenes retained: 40685 \n```\n\n\n:::\n:::\n\n\n``` r\nRepeated column names found in count matrix\ngenes retained: 40685 \n```\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# --------- 2. åŒ¹é…æ ·æœ¬ï¼ˆè¡¨è¾¾çŸ©é˜µåˆ— ä¸ clinical_data$case_idï¼‰ ----------\nif(!\"case_id\" %in% colnames(clinical_data)){\n  stop(\"clinical_data ä¸­æ‰¾ä¸åˆ° case_id åˆ—ï¼Œè¯·ç¡®è®¤åˆ—åã€‚\")\n}\nsamples_expr <- colnames(expr_mat)\nsamples_clin <- clinical_data$case_id\ncommon_samples <- intersect(samples_expr, samples_clin)\ncat(\"è¡¨è¾¾ä¸­æ ·æœ¬æ•°:\", length(samples_expr), \"\\nä¸´åºŠä¸­æ ·æœ¬æ•°:\", length(samples_clin), \"\\nåŒ¹é…åˆ°çš„æ ·æœ¬æ•°:\", length(common_samples), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nè¡¨è¾¾ä¸­æ ·æœ¬æ•°: 562 \nä¸´åºŠä¸­æ ·æœ¬æ•°: 493 \nåŒ¹é…åˆ°çš„æ ·æœ¬æ•°: 429 \n```\n\n\n:::\n\n```{.r .cell-code}\nif(length(common_samples) < 3) stop(\"åŒ¹é…æ ·æœ¬è¿‡å°‘ï¼Œæ— æ³•ç»§ç»­ã€‚\")\n```\n:::\n\n\n``` r\nè¡¨è¾¾ä¸­æ ·æœ¬æ•°: 562 \nä¸´åºŠä¸­æ ·æœ¬æ•°: 493 \nåŒ¹é…åˆ°çš„æ ·æœ¬æ•°: 490 \n```\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# å­é›†åŒ–å¹¶ç¡®ä¿é¡ºåºä¸€è‡´\nexpr_mat <- expr_mat[, common_samples, drop = FALSE]\nclinical_sub <- clinical_data[match(common_samples, clinical_data$case_id), , drop = FALSE]\nrownames(clinical_sub) <- clinical_sub$case_id\n```\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# --------- 3. æ’é™¤ Unknown stage çš„æ ·æœ¬ ----------\nif(!\"simplified_stage\" %in% colnames(clinical_sub)){\n  stop(\"clinical_data ä¸­æ²¡æœ‰ simplified_stage åˆ—ï¼Œè¯·å…ˆç”Ÿæˆã€‚\")\n}\nkeep_idx <- !is.na(clinical_sub$simplified_stage) & clinical_sub$simplified_stage != \"Unknown\"\nexpr_mat <- expr_mat[, keep_idx, drop = FALSE]\nclinical_sub <- clinical_sub[keep_idx, , drop = FALSE]\ncat(\"ç”¨äºå·®å¼‚åˆ†æçš„æ ·æœ¬æ•°:\", ncol(expr_mat), \"\\nå„ç»„åˆ†å¸ƒ:\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nç”¨äºå·®å¼‚åˆ†æçš„æ ·æœ¬æ•°: 425 \nå„ç»„åˆ†å¸ƒ:\n```\n\n\n:::\n\n```{.r .cell-code}\nprint(table(clinical_sub$simplified_stage))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n    Advanced (Stage III) Early/Local (Stage I-II) \n                      76                      349 \n```\n\n\n:::\n:::\n\n\n``` r\nç”¨äºå·®å¼‚åˆ†æçš„æ ·æœ¬æ•°: 425 \nå„ç»„åˆ†å¸ƒ:\n\n    Advanced (Stage III) Early/Local (Stage I-II) \n                      76                      349 \n                      \n```\n\n**å½’ä¸€åŒ–**ï¼šTMMï¼ˆedgeRï¼‰æˆ– DESeq2 å†…ç½®æ–¹æ³•å‡å¯ï¼›DESeq2 æ›´é€‚åˆç›´æ¥åšå·®å¼‚åˆ†æï¼ˆåŸå§‹æ•´æ•°è®¡æ•°ï¼‰ã€‚\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# --------- 4. ä½è¡¨è¾¾åŸºå› è¿‡æ»¤ï¼ˆedgeR CPMï¼‰ ----------\ndge <- DGEList(counts = expr_mat)\nkeep_genes <- rowSums(cpm(dge) > 1) >= 3   # è‡³å°‘ 3 ä¸ªæ ·æœ¬ CPM>1ï¼›å¯æ ¹æ®æ ·æœ¬é‡è°ƒæ•´\ndge <- dge[keep_genes, , keep.lib.sizes = FALSE]\ncat(\"è¿‡æ»¤åä¿ç•™åŸºå› æ•°:\", nrow(dge), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nè¿‡æ»¤åä¿ç•™åŸºå› æ•°: 37156 \n```\n\n\n:::\n:::\n\n\n``` r\nè¿‡æ»¤åä¿ç•™åŸºå› æ•°: 37156 \n```\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# --------- 5. æ— åå˜é‡ï¼ˆåªæ ¹æ® simplified_stage åˆ†ç»„ï¼‰ ----------\nclinical_sub$simplified_stage <- factor(clinical_sub$simplified_stage)\nif (\"Early/Local (Stage I-II)\" %in% levels(clinical_sub$simplified_stage)) {\n  clinical_sub$simplified_stage <- relevel(clinical_sub$simplified_stage, ref = \"Early/Local (Stage I-II)\")\n}\n\n# è®¾è®¡å…¬å¼\ndesign_formula <- ~ simplified_stage\ncat(\"ä½¿ç”¨çš„è®¾è®¡å…¬å¼ï¼š\", format(design_formula), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nä½¿ç”¨çš„è®¾è®¡å…¬å¼ï¼š ~simplified_stage \n```\n\n\n:::\n\n```{.r .cell-code}\nexpr_int <- apply(dge$counts, 2, as.integer)\nrownames(expr_int) <- rownames(dge$counts)\ndds <- DESeqDataSetFromMatrix(\n  countData = expr_int,\n  colData = clinical_sub,\n  design = design_formula\n)\n```\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# --------- 6. è¿è¡Œ DESeq2 ----------\ndds <- DESeq(dds)\n\n# --------- 7. è·å–å·®å¼‚ç»“æœ ----------\ncontrast_vec <- c(\"simplified_stage\", \"Advanced (Stage III)\", \"Early/Local (Stage I-II)\")\nres_raw <- results(dds, contrast = contrast_vec)\n\nif (requireNamespace(\"apeglm\", quietly = TRUE)) {\n  resLFC <- lfcShrink(\n  dds,\n  coef = \"simplified_stage_Advanced..Stage.III._vs_Early.Local..Stage.I.II.\",\n  type = \"apeglm\"\n)\n\n} else {\n  message(\"æœªå®‰è£… apeglmï¼Œå°†è¿”å›æœªæ”¶ç¼©çš„ç»“æœã€‚\")\n  resLFC <- res_raw\n}\n\nres_df <- as.data.frame(resLFC)\nres_df$gene <- rownames(res_df)\nres_df <- res_df[order(res_df$padj), ]\n\nwrite.csv(res_df, \"DEG_Advanced_vs_Early.csv\", row.names = FALSE)\ncat(\"å·®å¼‚åˆ†æç»“æœå·²ä¿å­˜ï¼šDEG_Advanced_vs_Early.csv\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nå·®å¼‚åˆ†æç»“æœå·²ä¿å­˜ï¼šDEG_Advanced_vs_Early.csv\n```\n\n\n:::\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# --------- 8. ç­›é€‰æ˜¾è‘—åŸºå›  ----------\nsig <- subset(res_df, !is.na(padj) & padj < 0.1 & abs(log2FoldChange) >= 0.3)\ncat(\"æ˜¾è‘— DEG æ•°é‡:\", nrow(sig), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\næ˜¾è‘— DEG æ•°é‡: 26 \n```\n\n\n:::\n\n```{.r .cell-code}\nwrite.csv(sig, \"significant_DEGs.csv\", row.names = FALSE)\n```\n:::\n\n\næ˜¾è‘— DEG æ•°é‡: 26\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# --------- 9. ç«å±±å›¾ ----------\nres_df$signif <- ifelse(!is.na(res_df$padj) & res_df$padj < 0.1 & abs(res_df$log2FoldChange) >= 0.3, \"yes\", \"no\")\n\nlibrary(ggplot2)\np_volcano <- ggplot(res_df, aes(x = log2FoldChange, y = -log10(pvalue), color = signif)) +\n  geom_point(alpha = 0.6, size = 1.2) +\n  scale_color_manual(values = c(\"no\" = \"grey70\", \"yes\" = \"red\")) +\n  theme_minimal() +\n  labs(title = \"Volcano Plot (Advanced vs Early)\", x = \"log2 Fold Change\", y = \"-log10(p-value)\")\n\nggsave(\"Volcano_DEG.png\", p_volcano, width = 7, height = 5, dpi = 300)\n```\n:::\n\n\n-   å°‘é‡ DEG â†’ åŸºäºå®ƒä»¬ç›´æ¥èšç±»**ä¸ç¨³å¥**ï¼ˆå—å•ä¸ªåŸºå› å¼ºå½±å“ï¼‰ã€‚\n\n    ä¼˜å…ˆåš**é™ç»´ / èšåˆ / æ¨¡å—åŒ–ç‰¹å¾**ï¼ˆæ¯”å¦‚ WGCNA æ¨¡å— eigengeneã€GSVA è·¯å¾„å¾—åˆ†ã€æˆ– top-variance åŸºå› é›†åˆï¼‰å†èšç±»ã€‚\n\n    è¦åŒæ—¶åš**æ— ç›‘ç£ï¼ˆå‘ç°äºšå‹ï¼‰ä¸æœ‰ç›‘ç£/éªŒè¯ï¼ˆæŒ‰ stage åˆ†å±‚æˆ–æ£€éªŒç°‡ä¸åˆ†æœŸ/ç”Ÿå­˜çš„å…³è”ï¼‰**ï¼Œä¸¤è€…äº’ä¸ºè¡¥å……ã€‚\n\n    ä½¿ç”¨**ç¨³å®šæ€§è¯„ä¼°**ï¼ˆsilhouette, consensus clustering, bootstrapï¼‰æ¥åˆ¤å®šç°‡ç»“æœæ˜¯å¦å¯é \n\n![](images/Volcano_DEG.png)\n\n## 1) **åŸºäº WGCNA æ¨¡å— Eigengenes å¯¹æ ·æœ¬èšç±»**\n\n**ç†ç”±**ï¼šWGCNA æŠŠåŸºå› é›†åˆæˆæ¨¡å—ï¼Œå†ç”¨æ¨¡å— eigengeneä½œä¸ºæ ·æœ¬ç‰¹å¾ï¼Œç»´åº¦ä½ã€ä¿¡å™ªæ¯”é«˜ï¼Œé€‚åˆæ ·æœ¬èšç±»ä¸”æ˜“è§£é‡Šä¸ºç”Ÿç‰©å­¦æ¨¡å—ã€‚\\\n**ä¼˜ç‚¹**ï¼šæ¯”ç›´æ¥ç”¨å‡ åä¸ª DEG æ›´ç¨³å¥ï¼›ä¾¿äºè§£é‡Šï¼ˆæ¨¡å— â†’ é€šè·¯ï¼‰\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(WGCNA)\noptions(stringsAsFactors = FALSE)\nallowWGCNAThreads()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nAllowing multi-threading with up to 16 threads.\n```\n\n\n:::\n\n```{.r .cell-code}\n# VST è½¬æ¢\nvsd <- vst(dds, blind = TRUE)\nvst_mat <- assay(vsd)\n\n# é€‰æ‹©é«˜å˜åŸºå› \ntop_var_genes <- order(apply(vst_mat, 1, var), decreasing = TRUE)[1:5000]\ndatExpr <- t(vst_mat[top_var_genes, ])\n\n# æ£€æŸ¥ç¼ºå¤±å€¼\ngsg <- goodSamplesGenes(datExpr, verbose = 3)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n Flagging genes and samples with too many missing values...\n  ..step 1\n```\n\n\n:::\n\n```{.r .cell-code}\nif (!gsg$allOK) datExpr <- datExpr[gsg$goodSamples, gsg$goodGenes]\n\n# è®¡ç®—è½¯é˜ˆå€¼\npowers <- c(1:20)\nsft <- pickSoftThreshold(datExpr, powerVector = powers, verbose = 5)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\npickSoftThreshold: will use block size 5000.\n pickSoftThreshold: calculating connectivity for given powers...\n   ..working on genes 1 through 5000 of 5000\n   Power SFT.R.sq  slope truncated.R.sq mean.k. median.k. max.k.\n1      1   0.0179 -0.308          0.897 665.000  6.37e+02 1290.0\n2      2   0.6500 -1.280          0.955 157.000  1.29e+02  529.0\n3      3   0.8680 -1.670          0.956  52.600  3.35e+01  298.0\n4      4   0.9220 -1.620          0.967  22.800  1.03e+01  192.0\n5      5   0.9340 -1.510          0.972  11.800  3.56e+00  135.0\n6      6   0.9350 -1.430          0.970   6.970  1.38e+00  101.0\n7      7   0.9240 -1.390          0.969   4.490  5.85e-01   78.5\n8      8   0.9350 -1.330          0.976   3.080  2.61e-01   62.8\n9      9   0.9260 -1.320          0.973   2.220  1.23e-01   51.4\n10    10   0.9090 -1.320          0.953   1.650  6.06e-02   42.8\n11    11   0.9170 -1.300          0.964   1.260  3.06e-02   36.1\n12    12   0.9190 -1.290          0.967   0.983  1.59e-02   30.8\n13    13   0.9120 -1.290          0.964   0.780  8.46e-03   26.4\n14    14   0.9040 -1.290          0.962   0.628  4.52e-03   22.9\n15    15   0.9090 -1.280          0.968   0.511  2.49e-03   19.9\n16    16   0.9110 -1.280          0.972   0.421  1.35e-03   17.4\n17    17   0.9100 -1.280          0.973   0.349  7.48e-04   15.3\n18    18   0.9140 -1.280          0.971   0.293  4.28e-04   13.5\n19    19   0.9240 -1.260          0.977   0.247  2.42e-04   11.9\n20    20   0.9250 -1.260          0.978   0.209  1.39e-04   10.6\n```\n\n\n:::\n\n```{.r .cell-code}\nsoftPower <- ifelse(any(sft$fitIndices[,2] > 0.8),\n                    min(sft$fitIndices$Power[sft$fitIndices[,2] > 0.8]),\n                    sft$fitIndices$Power[which.max(sft$fitIndices[,2])])\n\ncat(\"Chosen softPower =\", softPower, \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nChosen softPower = 3 \n```\n\n\n:::\n\n```{.r .cell-code}\n# æ„å»ºç½‘ç»œ\nnet <- blockwiseModules(datExpr, power = softPower,\n                        TOMType = \"unsigned\",\n                        minModuleSize = 30,\n                        mergeCutHeight = 0.25,\n                        numericLabels = TRUE,\n                        pamRespectsDendro = FALSE,\n                        saveTOMs = FALSE,\n                        verbose = 3)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n Calculating module eigengenes block-wise from all genes\n   Flagging genes and samples with too many missing values...\n    ..step 1\n ..Working on block 1 .\n    TOM calculation: adjacency..\n    ..will not use multithreading.\n     Fraction of slow calculations: 0.000000\n    ..connectivity..\n    ..matrix multiplication (system BLAS)..\n    ..normalization..\n    ..done.\n ....clustering..\n ....detecting modules..\n ....calculating module eigengenes..\n ....checking kME in modules..\n     ..removing 839 genes from module 1 because their KME is too low.\n     ..removing 258 genes from module 2 because their KME is too low.\n     ..removing 74 genes from module 3 because their KME is too low.\n     ..removing 79 genes from module 4 because their KME is too low.\n     ..removing 10 genes from module 5 because their KME is too low.\n     ..removing 32 genes from module 6 because their KME is too low.\n     ..removing 22 genes from module 7 because their KME is too low.\n     ..removing 24 genes from module 8 because their KME is too low.\n     ..removing 17 genes from module 9 because their KME is too low.\n     ..removing 3 genes from module 10 because their KME is too low.\n     ..removing 6 genes from module 11 because their KME is too low.\n     ..removing 2 genes from module 12 because their KME is too low.\n  ..reassigning 110 genes from module 1 to modules with higher KME.\n  ..reassigning 55 genes from module 2 to modules with higher KME.\n  ..reassigning 21 genes from module 3 to modules with higher KME.\n  ..reassigning 11 genes from module 4 to modules with higher KME.\n  ..reassigning 6 genes from module 5 to modules with higher KME.\n  ..reassigning 1 genes from module 6 to modules with higher KME.\n  ..reassigning 8 genes from module 7 to modules with higher KME.\n  ..reassigning 1 genes from module 9 to modules with higher KME.\n  ..reassigning 1 genes from module 10 to modules with higher KME.\n  ..reassigning 1 genes from module 12 to modules with higher KME.\n ..merging modules that are too close..\n     mergeCloseModules: Merging modules whose distance is less than 0.25\n       Calculating new MEs...\n```\n\n\n:::\n\n```{.r .cell-code}\nMEs <- net$MEs\nmoduleColors <- labels2colors(net$colors)\n```\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# æå–æ ·æœ¬é¡ºåº\nsampleNames <- rownames(datExpr)\nhead(sampleNames)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"TCGA-90-A4EE\" \"TCGA-85-8049\" \"TCGA-39-5016\" \"TCGA-56-8304\" \"TCGA-92-8063\"\n[6] \"TCGA-43-8115\"\n```\n\n\n:::\n\n```{.r .cell-code}\n# ä» clinical_sub æå– simplified_stage\ntrait_df <- clinical_sub %>%\n  dplyr::filter(case_id %in% sampleNames) %>%\n  dplyr::arrange(match(case_id, sampleNames))\n\n# äºŒå€¼åŒ– simplified_stage\ntrait <- ifelse(trait_df$simplified_stage == \"Advanced (Stage III)\", 1, 0)\n\nlength(trait)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 425\n```\n\n\n:::\n\n```{.r .cell-code}\nlength(sampleNames)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 425\n```\n\n\n:::\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#  datExpr å·²ç»æ˜¯è¡Œ = æ ·æœ¬, åˆ— = åŸºå› \nsampleNames <- rownames(datExpr)\n\n# ç¡®ä¿ simplified_stage å­˜åœ¨ä¸”æ—  NA\nclinical_sub <- clinical_data %>%\n  filter(case_id %in% sampleNames & !is.na(simplified_stage)) %>%\n  arrange(match(case_id, sampleNames))\n\n# æ£€æŸ¥åŒ¹é…æƒ…å†µ\ncat(\"è¡¨è¾¾çŸ©é˜µæ ·æœ¬æ•°:\", nrow(datExpr), \"\\nä¸´åºŠåŒ¹é…æ•°:\", nrow(clinical_sub), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nè¡¨è¾¾çŸ©é˜µæ ·æœ¬æ•°: 425 \nä¸´åºŠåŒ¹é…æ•°: 425 \n```\n\n\n:::\n\n```{.r .cell-code}\n# äºŒå€¼åŒ– simplified_stage\ntrait <- ifelse(clinical_sub$simplified_stage == \"Advanced (Stage III)\", 1, 0)\n\n# æ£€æŸ¥ trait é•¿åº¦æ˜¯å¦åŒ¹é…\nlength(trait)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 425\n```\n\n\n:::\n\n```{.r .cell-code}\nlength(sampleNames)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 425\n```\n\n\n:::\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmoduleTraitCor <- cor(MEs, trait, use = \"p\")\nmoduleTraitPvalue <- corPvalueStudent(moduleTraitCor, nSamples = nrow(datExpr))\n\n# ç»˜åˆ¶ç›¸å…³çƒ­å›¾\ntextMatrix <- paste(signif(moduleTraitCor, 2), \"\\n(\",\n                    signif(moduleTraitPvalue, 1), \")\", sep = \"\")\ndim(textMatrix) <- dim(moduleTraitCor)\n\nlabeledHeatmap(Matrix = moduleTraitCor,\n               xLabels = \"Simplified Stage (Advanced=1)\",\n               yLabels = names(MEs),\n               ySymbols = names(MEs),\n               colorLabels = FALSE,\n               colors = blueWhiteRed(50),\n               textMatrix = textMatrix,\n               setStdMargins = FALSE,\n               cex.text = 0.7,\n               zlim = c(-1,1),\n               main = \"Module-trait relationships\")\n```\n\n::: {.cell-output-display}\n![](test1_files/figure-docx/unnamed-chunk-21-1.png)\n:::\n:::\n\n\n![](plot-10.png)\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlength(trait)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 425\n```\n\n\n:::\n\n```{.r .cell-code}\nnrow(datExpr)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 425\n```\n\n\n:::\n:::\n\n\n``` r\n> length(trait)\n+ nrow(datExpr)\n[1] 425\n[1] 425\n```\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# ==============================\n# ç¬¬ 8 æ­¥ï¼šæå–æ˜¾è‘—æ¨¡å— + DEG å¹¶é›†\n# ==============================\n\n# è®¾ç½®æ˜¾è‘—é˜ˆå€¼\nsig_modules <- rownames(moduleTraitCor)[abs(moduleTraitCor[,1]) > 0.3 & moduleTraitPvalue[,1] < 0.05]\n\ncat(\"æ˜¾è‘—æ¨¡å—:\", sig_modules, \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\næ˜¾è‘—æ¨¡å—:  \n```\n\n\n:::\n\n```{.r .cell-code}\n# è‹¥æ²¡æœ‰æ˜¾è‘—æ¨¡å—ï¼Œå¯æ”¾å®½é˜ˆå€¼æˆ–é€‰å– top 1 æ¨¡å—\nif (length(sig_modules) == 0) {\n  sig_modules <- rownames(moduleTraitCor)[order(abs(moduleTraitCor[,1]), decreasing = TRUE)[1]]\n  cat(\"æœªæ‰¾åˆ°æ˜¾è‘—æ¨¡å—ï¼Œè‡ªåŠ¨é€‰æ‹©æœ€é«˜ç›¸å…³æ¨¡å—:\", sig_modules, \"\\n\")\n}\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\næœªæ‰¾åˆ°æ˜¾è‘—æ¨¡å—ï¼Œè‡ªåŠ¨é€‰æ‹©æœ€é«˜ç›¸å…³æ¨¡å—: ME8 \n```\n\n\n:::\n\n```{.r .cell-code}\n# æå–è¿™äº›æ¨¡å—çš„åŸºå› \nsig_genes <- names(net$colors)[net$colors %in% match(sig_modules, rownames(moduleTraitCor))]\n\ncat(\"æ˜¾è‘—æ¨¡å—åŒ…å«åŸºå› æ•°:\", length(sig_genes), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\næ˜¾è‘—æ¨¡å—åŒ…å«åŸºå› æ•°: 226 \n```\n\n\n:::\n\n```{.r .cell-code}\n# å– DEG çš„æ˜¾è‘—åŸºå› \nDEG_genes <- rownames(resLFC[which(resLFC$padj < 0.2 & abs(resLFC$log2FoldChange) >= 0.5), ])\n\ncat(\"å·®å¼‚åŸºå› æ•°:\", length(DEG_genes), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nå·®å¼‚åŸºå› æ•°: 18 \n```\n\n\n:::\n\n```{.r .cell-code}\n# å¹¶é›†\ngene_union <- union(sig_genes, DEG_genes)\ncat(\"ç”¨äºèšç±»åˆ†æçš„åŸºå› æ•°:\", length(gene_union), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nç”¨äºèšç±»åˆ†æçš„åŸºå› æ•°: 244 \n```\n\n\n:::\n\n```{.r .cell-code}\nexpr_for_cluster <- t(vst_mat[intersect(rownames(vst_mat), gene_union), ])\n```\n:::\n\n\n![](plot-11.png)\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# ==============================\n# ç¬¬ 9 æ­¥ï¼šK-means èšç±» + è‚˜ç‚¹æ³•é€‰æ‹© k\n# ==============================\n\nlibrary(factoextra)\n\n# è®¡ç®—æ€»å¹³æ–¹è¯¯å·®ï¼ˆSSEï¼‰\nfviz_nbclust(expr_for_cluster, kmeans, method = \"wss\") +\n  ggtitle(\"Elbow method for optimal k\")\n```\n\n::: {.cell-output-display}\n![](test1_files/figure-docx/unnamed-chunk-24-1.png)\n:::\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# ï¼ˆæ ¹æ®è‚˜ç‚¹é€‰æ‹© k å€¼ï¼Œä¾‹å¦‚ k = 2 æˆ– 3ï¼‰\nset.seed(123)\nk_opt <- 4  # ä½ å¯ä»¥æ ¹æ®ä¸Šå›¾è‚˜ç‚¹ä¿®æ”¹\nkm_res <- kmeans(scale(expr_for_cluster), centers = k_opt, nstart = 25)\n\n# å°†èšç±»ç»“æœé™„åŠ åˆ°ä¸´åºŠæ•°æ®\nclinical_cluster <- clinical_sub\nclinical_cluster$cluster <- factor(km_res$cluster)\ntable(clinical_cluster$cluster)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n  1   2   3   4 \n124 131  85  85 \n```\n\n\n:::\n:::\n\n\n``` r\n\n  1   2   3   4 \n125 131  84  85 \n```\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# ==============================\n# ç¬¬ 10 æ­¥ï¼šç»˜åˆ¶çƒ­å›¾\n# ==============================\nlibrary(pheatmap)\n\n# é€‰æ‹©å‰ 100 ä¸ªæœ€å…·æ–¹å·®åŸºå› ä»¥ä¾¿å¯è§†åŒ–ï¼ˆå¦åˆ™å¤ªå¤šï¼‰\ntop_genes_vis <- order(apply(expr_for_cluster, 2, var), decreasing = TRUE)[1:100]\n\nannotation_col <- data.frame(\n  Stage = clinical_cluster$simplified_stage,\n  Cluster = clinical_cluster$cluster\n)\nrownames(annotation_col) <- rownames(expr_for_cluster)\n\npheatmap(\n  t(expr_for_cluster[, top_genes_vis]),\n  annotation_col = annotation_col,\n  show_colnames = FALSE,\n  show_rownames = FALSE,\n  scale = \"row\",\n  clustering_method = \"ward.D2\",\n  main = \"DEG + WGCNA modules heatmap\"\n)\n```\n\n::: {.cell-output-display}\n![](test1_files/figure-docx/unnamed-chunk-26-1.png)\n:::\n:::\n\n\n-   ![](plot-15.png)\n\n-   **DESeq2**ï¼šåªå¾—åˆ°å‡ åä¸ªå·®å¼‚åŸºå›  â†’ è¯´æ˜ç»„é—´å·®å¼‚æ•´ä½“è¾ƒå¼±ï¼›\n\n    **WGCNA**ï¼šæ²¡æ‰¾åˆ°æ˜¾è‘—ç›¸å…³æ¨¡å—ï¼Œä½†å‘ç°äº†ä¸€ä¸ªæœ€ç›¸å…³æ¨¡å—ï¼ˆME8ï¼Œ226ä¸ªåŸºå› ï¼‰ï¼›\n\n    **çƒ­å›¾ç»“æœ**ï¼šgroup åˆ†ç»„ä¸èƒ½æ¸…æ™°åŒºåˆ†æ ·æœ¬è¡¨è¾¾æ¨¡å¼\n\n    **ç»“è®º**ï¼šåˆ†ç»„ï¼ˆå¯èƒ½æ˜¯é«˜ä½ã€ç—…ä¾‹/å¯¹ç…§ï¼‰åœ¨è¡¨è¾¾å±‚é¢ä¸Šä¸å¤Ÿæ˜¾è‘—ï¼›\n\n    **æ­£ç¡®é€‰æ‹©**ï¼šä¸å†ç”¨â€œç›‘ç£èšç±»â€ï¼ˆå³å¼ºè¡ŒæŒ‰ group åŒºåˆ†ï¼‰ï¼Œè€Œæ”¹ä¸º **æ— ç›‘ç£èšç±»** æˆ–ä½¿ç”¨ **å¤–éƒ¨æ•°æ®åº“ç­›åŸºå› ï¼ˆå¦‚ GEPIA / GVES / TCGAï¼‰**ã€‚\n\néªŒè¯ä½ çš„åˆ†ç»„ï¼ˆå¦‚ `simplified_stage` ä¸­çš„ â€œEarly/Local (Stage I-II)â€ vs â€œAdvanced (Stage III)â€ï¼‰æ˜¯å¦èƒ½åŒºåˆ†æ ·æœ¬çš„è¡¨è¾¾æ¨¡å¼ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‡ ç§æ–¹æ³•è¿›è¡Œ**æ— ç›‘ç£ä¸æœ‰ç›‘ç£çš„éªŒè¯**ï¼š\n\n## âœ… æ–¹æ³•ä¸€ï¼šä¸»æˆåˆ†åˆ†æï¼ˆPCAï¼‰\n\n**ç›®çš„**ï¼šæŸ¥çœ‹ä¸åŒåˆ†ç»„çš„æ ·æœ¬åœ¨ä¸»æˆåˆ†ç©ºé—´ä¸­æ˜¯å¦èšé›†æˆ–åˆ†ç¦»ã€‚\n\nr\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# ä½¿ç”¨ VST è½¬æ¢åçš„è¡¨è¾¾çŸ©é˜µ\nvsd <- vst(dds, blind = FALSE)\nmat_vst <- assay(vsd)\n\n# PCA\npca <- prcomp(t(mat_vst))\npc_df <- data.frame(PC1 = pca$x[,1], PC2 = pca$x[,2],\n                    Stage = clinical_sub$simplified_stage)\nggplot(pc_df, aes(x = PC1, y = PC2, color = Stage)) +\n  geom_point(size = 2) +\n  theme_minimal() +\n  labs(title = \"PCA: Expression Pattern by Stage\")\n```\n\n::: {.cell-output-display}\n![](test1_files/figure-docx/unnamed-chunk-27-1.png)\n:::\n:::\n\n\n![](plot-18.png)\n\n**è§£è¯»**ï¼š\n\n-   ä¸åŒåˆ†ç»„çš„æ ·æœ¬åœ¨ PCA å›¾ä¸­ä¸å½¢æˆæ˜æ˜¾åˆ†ç¦»çš„ç°‡ï¼Œè¯´æ˜åˆ†ç»„ä¸èƒ½è¾ƒå¥½åœ°åŒºåˆ†è¡¨è¾¾æ¨¡å¼ã€‚\n\n-   æ··åœ¨ä¸€èµ·ï¼Œè¯´æ˜è¡¨è¾¾å·®å¼‚ä¸æ˜æ˜¾æˆ–å™ªå£°è¾ƒå¤§ã€‚\n\n## ğŸ§¬ ä¸‰ã€æ— ç›‘ç£èšç±»çš„ä¸¤ç§å¸¸ç”¨æ–¹æ³•\n\n### 1ï¸âƒ£ ç›´æ¥è·³è¿‡WGCNAWGCNA\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(pheatmap)\nlibrary(factoextra)\n\n# ä½¿ç”¨æ ·æœ¬è¡¨è¾¾çŸ©é˜µçš„è½¬ç½® (æ ·æœ¬ Ã— åŸºå› )\n\n\n# ç”¨è‚˜éƒ¨æ³•ç¡®å®šæœ€ä½³K\nfviz_nbclust(datExpr, kmeans, method = \"wss\")\n```\n\n::: {.cell-output-display}\n![](test1_files/figure-docx/unnamed-chunk-28-1.png)\n:::\n\n```{.r .cell-code}\n# èšç±»\nset.seed(123)\nkm_res <- kmeans(datExpr, centers = 4, nstart = 25)\nfviz_cluster(km_res, data = datExpr)\n```\n\n::: {.cell-output-display}\n![](test1_files/figure-docx/unnamed-chunk-28-2.png)\n:::\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntopVarGenes <- order(apply(mat_vst, 1, var), decreasing = TRUE)[1:1000]\ncommon_samples <- intersect(common_samples, colnames(mat_vst))\n\nexpr_topVar <- mat_vst[topVarGenes, common_samples]\n\n# 2. æ ‡å‡†åŒ–\nexpr_topVar <- t(scale(t(expr_topVar)))\n\nrownames(annotation_col) <- colnames(expr_topVar)\n\npheatmap(expr_topVar,\n         annotation_col = annotation_col,\n         clustering_distance_cols = \"euclidean\",\n         clustering_method = \"ward.D2\",\n         show_colnames = FALSE,\n         show_rownames = FALSE,\n         main = \"Unsupervised clustering of top variable genes\")\n```\n\n::: {.cell-output-display}\n![](test1_files/figure-docx/unnamed-chunk-29-1.png)\n:::\n:::\n\n\nè¿™ä¸€æ­¥å¯ä»¥å¸®åŠ©ä½ **å‘ç°æ–°çš„æ ·æœ¬äºšå‹ç»“æ„**ã€‚\n\n![](plot-23.png)\n\n![](plot-27.png)\n\nåé¢æ‰“ç®—åšgvesçš„ï¼Œä½†æ˜¯æ„Ÿè§‰è¿™ä¸ªæ•°æ®åšè¿™ä¸ªå¯èƒ½æ²¡ä»€ä¹ˆæ„ä¹‰æ‹‰åˆ°å¾—äº†",
    "supporting": [
      "test1_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": null,
    "postProcess": false
  }
}